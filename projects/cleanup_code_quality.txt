Code Quality Cleanup Backlog
============================

Items a Rust expert would flag, roughly ordered by impact:

1. [DONE] GVN pass parameter threading -> GvnState struct
   - gvn_dfs had 14 params, process_block had 10 params
   - Fixed by introducing GvnState struct with save_scope/restore_scope

2. [DONE] Functions with 10-20+ parameters
   - parse_declaration_rest: 22 params -> DeclContext struct (DeclAttributes + alignment info)
   - parse_function_def: 11 params -> accepts DeclAttributes directly
   - resolve_type_flags: 16 boolean params -> TypeSpecFlags struct
   - collect_trailing_specifiers: 10 params -> TypeSpecFlags struct
   - gvn_dfs: DONE (was 14 params, now GvnState struct)

3. [PARTIAL] Visibility: was 836 pub + 18 pub(crate), now improved at module level
   - All 22 mod.rs files updated: pub mod -> pub(crate) mod throughout
   - Only lib.rs::backend and lib.rs::driver remain pub (needed by main.rs)
   - backend::CodegenOptions and its fields changed to pub(crate)
   - backend::Target methods (except triple()) changed to pub(crate)
   - Unused re-exports removed (ir::*, ast::*, sema builtins, codegen types)
   - Remaining: individual pub fn/struct/enum/const within pub(crate) modules
     are semantically capped at pub(crate) by Rust's visibility rules, but
     could be explicitly marked pub(crate) for consistency. Low priority since
     the module-level changes already enforce the correct boundary.
   - The tighter visibility now exposes ~67 dead code warnings (previously
     hidden behind pub), which could be cleaned up separately.

4. [PARTIAL] String allocations from literals (medium effort)
   - Was 420 .to_string() calls, now 334 (86 eliminated)
   - Register name functions (reg_to_32, reg_to_16, reg_to_64, reg_to_8l,
     reg_to_8h) in x86 and i686 backends now return Cow<'_, str> instead
     of String, avoiding heap allocations for known register names.
     format_x86_reg, format_i686_reg, src_reg_for_type, dest_reg_for_type
     also updated. x86_normalize_reg_to_64bit returns Cow<'static, str>.
   - Remaining: builtin_macros.rs (41 calls), preprocessor includes (33),
     other frontend/IR files (~260 remaining calls)

5. format! in codegen hot paths, zero write! usage (medium effort)
   - 320 format! calls across the codebase, 0 write!/writeln!
   - ARM codegen loops allocate 2 Strings per iteration for register names
   - Could use static lookup tables for register names

6. Deep nesting (16 levels) in global_init.rs (small-medium effort)
   - Nested match/if-let chains at src/ir/lowering/global_init.rs:490-522
   - Extract compound literal handling into helper functions

7. Lowerer split across 37 files (large effort, low priority)
   - Valid Rust pattern but extreme; makes API surface hard to understand
   - Consider grouping related impl blocks or adding a module-level doc

8. [DONE] x86/i686 code duplication -> x86_common module
   - gcc_cc_to_x86: exact duplicate extracted to shared free function
   - reg_to_32, reg_to_16, reg_to_8l, reg_to_8h: merged to accept both
     64-bit and 32-bit register names in a single match
   - substitute_*_asm_operands: ~150 lines of identical template parsing
     extracted to shared function parameterized by operand emission callback
   - emit_operand_common: shared logic for %n/%c/%P/memory/$symbol/$imm
   - Both backends now delegate through thin wrappers to x86_common
   - ~400 lines removed, zero functional changes
