LOW PRIORITY: Structured error infrastructure follow-ups

COMPLETED (2026-01-28):
- Created DiagnosticEngine in common/error.rs with Diagnostic, Severity, source snippets
- Wired into parser: all 4 eprintln! error sites replaced with emit_error()
- Wired into sema: errors and warnings go through DiagnosticEngine
- Wired into preprocessor: #warning collected as warnings (not bare eprintln!)
- Driver threads DiagnosticEngine through parser -> sema pipeline
- Source snippet rendering with caret/underline using SourceManager::get_source_line()
- GCC-compatible output format: "file:line:col: error: message"

COMPLETED (2026-01-28):
- Added WarningKind enum with categorized warnings (Undeclared, ImplicitFunctionDeclaration, Cpp)
- Added WarningConfig for per-warning enable/disable and error promotion
- Implemented -Werror (global), -Werror=<name>, -Wno-error=<name> for selective promotion
- Implemented -Wall, -Wextra, -W<name>, -Wno-<name> for warning control
- Left-to-right flag processing matching GCC semantics
- GCC-style [-W<name>] and [-Werror=<name>] suffixes on diagnostic messages
- Updated sema and preprocessor warning sites with WarningKind tags
- Wired WarningConfig from CLI through Driver to DiagnosticEngine

COMPLETED (2026-01-28):
- Added source spans to all 3 sema diagnostic sites:
  - "switch quantity is not an integer" error now includes the expression span
  - "'name' undeclared" warning now includes the identifier span
  - "implicit declaration of function 'name'" warning now includes the callee span
- Removed legacy `errors: Vec<String>` from SemanticAnalyzer; now uses
  DiagnosticEngine.has_errors() / error_count() exclusively
- Changed analyze() return type from Result<(), Vec<String>> to Result<(), usize>
- Added first "note:" follow-up message: switch type error now includes
  "note: expression has type 'Foo'" with span pointing to the expression
- Removed #[allow(dead_code)] from Diagnostic::with_note() (now in active use)

COMPLETED (2026-01-28):
- Wired DiagnosticEngine into the IR lowering phase:
  - Added DiagnosticEngine field (RefCell-wrapped) to Lowerer struct
  - Driver threads DiagnosticEngine: parser -> sema -> lowerer pipeline
  - Lowerer::lower() returns (IrModule, DiagnosticEngine) tuple
  - Driver checks for lowering errors after IR generation
  - Added emit_warning() helper using RefCell for interior mutability
    (many lowering methods take &self, same pattern as expr_ctype_cache)
  - Added diagnostics for unresolved typeof expressions (was a TODO)
  - Added diagnostics for __auto_type inference failures
  - All diagnostics include source spans for GCC-compatible location output

COMPLETED (2026-01-28):
- Added Display impl for CType in common/types.rs to show user-friendly C-style
  type names in diagnostics (e.g., "unsigned int" instead of "UInt", "char *"
  instead of "Pointer(Char)", "void (*)(int)" for function pointers)
- Updated sema diagnostic site to use Display (format with {}) instead of Debug ({:?})
  for CType in the "expression has type '...'" note message

COMPLETED (2026-01-30):
- Added fix-it hint infrastructure: Diagnostic.fix_hint field rendered below snippets
- Added expect_after() parser method for context-aware error messages
  (e.g., "expected ';' after return statement" instead of "expected ';' before '}'")
- Added expect_closing() parser method for delimiter matching notes
  (e.g., "note: to match this '(' at file.c:10:5")
- Updated all statement semicolons with context: return, break, continue, goto,
  do-while, for-loop, expression statements
- Updated struct/enum/initializer closing braces with opening brace notes
- Updated function calls, parenthesized expressions, array subscripts,
  _Alignof, __alignof__, __builtin_va_arg, __builtin_types_compatible_p,
  _Generic, _Static_assert with closing paren notes
- Updated declaration semicolons (external, local, K&R params, struct fields)

COMPLETED (2026-01-30):
- Added ANSI color output to diagnostics matching GCC's color scheme:
  - Bold red for "error:", bold magenta for "warning:", bold cyan for "note:"
  - Bold white for file:line:col location and message text
  - Bold green for caret/underline and fix-it hints
- Added ColorMode enum (Auto/Always/Never) with isatty detection (std::io::IsTerminal)
- Added -fdiagnostics-color={auto,always,never} flag to driver CLI
- Added -fcolor-diagnostics/-fno-color-diagnostics (Clang-compatible aliases)
- Default mode is Auto: colors when stderr is a terminal, plain when piped

COMPLETED (2026-01-30):
- Added GCC-style "In file included from" include chain traces in diagnostics:
  - Preprocessor now emits GCC-style flags in line markers (flag 1 = enter include,
    flag 2 = return from include)
  - SourceManager.build_line_map() parses flags to build include origin map
  - SourceManager.get_include_chain() walks parent links to build full chain
  - DiagnosticEngine.render_include_trace() emits chain before errors in headers
  - Matches GCC output format: "In file included from X:Y," / "from X:Y:"
  - Chain is only shown once per file (consecutive errors skip repeat traces)

COMPLETED (2026-01-30):
- Added expect_context() parser method for contextual error messages with fix-it hints
  (e.g., "expected '(' after 'if'" instead of "expected '(' before 'x'")
- Added fix-it hints to expect_closing() (e.g., "fix-it hint: insert ')'")
- Converted 30+ bare expect() calls across parser to contextual versions:
  - statements.rs: if/while/for/switch/do-while/case/default/asm with context strings
  - expressions.rs: _Alignof/__alignof__/__builtin_va_arg/__builtin_types_compatible_p/
    _Generic/ternary operator with context strings
  - types.rs: _Atomic/typeof/struct/enum bodies with context strings
  - declarations.rs: _Static_assert/designator brackets with context
  - declarators.rs: parameter lists/array brackets with context
- Fixed 3 silent error sites where error_count++ had no diagnostic message:
  - __int128 on 32-bit: now emits "__int128 is not supported on this target"
  - __uint128_t on 32-bit: now emits "__uint128_t is not supported on this target"
  - TI mode on 32-bit: now emits "TI mode is not supported on 32-bit targets"

COMPLETED (2026-01-30):
- Added macro expansion tracing: "note: in expansion of macro 'X'" diagnostic notes
  - MacroTable tracks which macros are expanded during each expand_line_reuse() call
  - Preprocessor collects per-line macro expansion metadata during preprocessing
  - SourceManager stores and indexes macro expansion info by pp output line number
  - DiagnosticEngine renders "in expansion of macro 'X'" notes for errors/warnings
    in macro-expanded code, showing up to 3 levels of nested expansion chain
  - Filters out uninteresting macros (__builtin_*, NULL, INT_MAX, etc.) to reduce noise
  - Supports ANSI color output matching GCC's color scheme
  - Driver threads macro expansion info from preprocessor to source manager

REMAINING FOLLOW-UPS:
1. [DONE] Add source locations to preprocessor errors (#error, #warning, missing #include)
   - Added PreprocessorDiagnostic struct with file:line:col in preprocessor.rs
   - Added explicit_location field to Diagnostic for pre-SourceManager diagnostics
   - Driver now forwards preprocessor diagnostics with GCC-compatible file:line:col: prefix
2. Add more WarningKind categories as compiler implements more warnings
   (UnusedVariable, SignCompare, ImplicitConversion, etc.)
   NOTE: ReturnType was implemented (2026-01-30) â€” -Wreturn-type warning in sema
3. Add more "note:" follow-ups: "previous declaration was here", "did you mean to include <header>?"
4. Add more lowering diagnostics: unresolved lvalue in assignments, unresolved typedefs,
   vector type mismatches in compound assignment
5. [DONE] Add macro expansion tracing ("in expansion of macro 'X'")
6. Improve macro expansion tracing to token-level granularity (currently line-level)
   - Would require preprocessor to track byte ranges per expansion, not just line numbers
   - Current approach tracks which macros were expanded on each output line

Key files:
- src/common/error.rs (DiagnosticEngine, Diagnostic, Severity, with_note, with_fix_hint)
- src/common/source.rs (SourceManager with line map, get_source_line for snippets)
- src/frontend/parser/parser.rs (uses emit_error/emit_warning, expect_after, expect_closing, expect_context)
- src/frontend/sema/sema.rs (uses diagnostics.error/warning_with_kind with spans)
- src/ir/lowering/lowering.rs (uses RefCell<DiagnosticEngine> for &self methods)
- src/frontend/preprocessor/preprocessor.rs (PreprocessorDiagnostic, collects errors and warnings)
- src/driver/driver.rs (creates and threads DiagnosticEngine through phases)
